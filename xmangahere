#!/usr/bin/env python
#
# This file is part of xmangahere project.
#
# Copyright (C) 2019 aliceinthedark <don't @ me>
# All Rights Reserved
# 
# This program is free software. It comes without any warranty, to
# the extent permitted by applicable law. You can redistribute it
# and/or modify it under the terms of the Do What The Fuck You Want
# To Public License, Version 2, as published by Sam Hocevar. See
# LICENSE.md for more details.
#

from typing import NoReturn

from subprocess import Popen, PIPE

def get_search_query_menu() -> str:
    with Popen(['rofi', '-dmenu', '-lines', '0'], stdout=PIPE) as p:
        return p.stdout.read().decode('utf-8').replace('\n', '')

def get_matching_titles(query: str) -> [str]:
    with Popen(['./search.py', query], stdout=PIPE) as p:
        return p.stdout.read().decode('utf-8').split('\n')

def get_selected_title_menu(titles: [str]) -> str:
    with Popen(['rofi', '-dmenu'], stdout=PIPE, stdin=PIPE) as menu:
        with menu.stdin:
            menu.stdin.write('\n'.join(titles).encode('utf-8'))
        return menu.stdout.read().decode('utf-8').replace('\n', '')

def get_volumes(title: str) -> [str]:
    with Popen(['./loadvolumes.py', title], stdout=PIPE) as p:
        return p.stdout.read().decode('utf-8').split('\n')

def get_selected_volume_menu(volumes: [str]) -> str:
    with Popen(['rofi', '-dmenu'], stdout=PIPE, stdin=PIPE) as menu:
        with menu.stdin:
            menu.stdin.write('\n'.join(volumes).encode('utf-8'))
        return menu.stdout.read().decode('utf-8').replace('\n', '')

def get_page_links(volume: str) -> [str]:
    with Popen(['./loadpages.py', volume], stdout=PIPE) as p:
        return p.stdout.read().decode('utf-8').split('\n')

def get_saved_images(links: [str]) -> [str]:
    with Popen(['./saveimages.py', ' '.join(links)], stdout=PIPE) as p:
        return p.stdout.read().decode('utf-8').split('\n')

def show_viewer(images: [str]) -> NoReturn:
    with Popen(['feh', '-.', *images]) as feh:
        return feh.returncode

def main() -> NoReturn:
    while True:
        query = get_search_query_menu()
        if query == '':
            break
        titles = get_matching_titles(query)
        while True:
            title = get_selected_title_menu(titles)
            if title == '':
                break
            volumes = get_volumes(title)
            while True:
                volume = get_selected_volume_menu(volumes)
                if volume == '':
                    break
                page_links = get_page_links(volume)
                images = get_saved_images(page_links)
                show_viewer(images)

if __name__ == '__main__':
    main()
